var e,t="jp",r="\r\n",n=PPx.CreateObject("Scripting.FileSystemObject"),i=1024,a={TypeToCode:{crlf:"\r\n",cr:"\r",lf:"\n"},CodeToType:{"\r\n":"crlf","\r":"cr","\n":"lf"},Ppx:{lf:"%%bl",cr:"%%br",crlf:"%%bn",unix:"%%bl",mac:"%%br",dos:"%%bn","\n":"%%bl","\r":"%%br","\r\n":"%%bn"},Ascii:{lf:"10",cr:"13",crlf:"-1",unix:"10",mac:"13",dos:"-1","\n":"10","\r":"13","\r\n":"-1"}},l=function(e,t){try{var r;return[!1,null!=(r=t())?r:""]}catch(n){return[!0,""]}finally{e.Close()}},s=function(e){var t=e.path,r=e.enc,i=function(e){var t=e.path,r=e.enc,i=void 0===r?"utf8":r;if(!n.FileExists(t))return[!0,t+" not found"];var a=n.GetFile(t);if(0===a.Size)return[!0,t+" has no data"];var s=!1,u="";if("utf8"===i){var c=PPx.CreateObject("ADODB.Stream"),o=l(c,(function(){return c.Open(),c.Charset="UTF-8",c.LoadFromFile(t),c.ReadText(-1)}));s=o[0],u=o[1]}else{var f="utf16le"===i?-1:0,p=a.OpenAsTextStream(1,f),x=l(p,(function(){return p.ReadAll()}));s=x[0],u=x[1]}return s?[!0,"Unable to read "+t]:[!1,u]}({path:t,enc:void 0===r?"utf8":r}),a=i[0],s=i[1];if(a)return[!0,s];var u=function(e){var t="\n",r=e.indexOf("\r");return~r&&(t="\r\n"==e.substring(r,r+2)?"\r\n":"\r"),t}(s.slice(0,1e3)),c=s.split(u);return""===c[c.length-1]&&c.pop(),[!1,{lines:c,nl:u}]},u=function(e){var t=e.path,i=e.data,s=e.enc,u=void 0===s?"utf8":s,c=e.append,o=void 0!==c&&c,f=e.overwrite,p=void 0!==f&&f,x=e.linefeed,P=void 0===x?r:x;if(!p&&!o&&n.FileExists(t))return[!0,t+" already exists"];var d,v=n.GetParentFolderName(t);if(n.FolderExists(v)||PPx.Execute("*makedir "+v),"utf8"===u){if("ClearScriptV8"===PPx.ScriptEngineName){var T=i.join(P),E=o?"AppendAllText":"WriteAllText";return[!1,NETAPI.System.IO.File[E](t,T)]}var h=p||o?2:1,m=PPx.CreateObject("ADODB.Stream");d=l(m,(function(){m.Open(),m.Charset="UTF-8",m.LineSeparator=Number(a.Ascii[P]),o?(m.LoadFromFile(t),m.Position=m.Size,m.SetEOS):m.Position=0,m.WriteText(i.join(P),1),m.SaveToFile(t,h)}))[0]}else{var g=o?8:p?2:1;n.FileExists(t)||PPx.Execute("%Osq *makefile "+t);var F="utf16le"===u?-1:0,b=n.GetFile(t).OpenAsTextStream(g,F);d=l(b,(function(){b.Write(i.join(P)+P)}))[0]}return d?[!0,"Could not write to "+t]:[!1,""]},c="sjis",o=r,f={en:{notExists:"does not exist",update:"Update PPXUPATH.TXT"},jp:{notExists:"がありません",update:"PPXUPATH.TXT を更新しました"}}[function(){var e=PPx.Extract("%*getcust(S_ppm#global:lang)");return"en"===e||"jp"===e?e:t}()],p={scanExe:(e=PPx.Extract("%0%\\"))+"fenrirScan.exe",scanRule:e+"ScanRule.ini",fpath:e+"PPXFPATH.TXT",upath:e+"PPXUPATH.TXT"},x=function(e){var t=n.GetFile(e);return i&t.Attributes?PPx.Extract("%*linkedpath("+e+")"):e},P=function(e){for(var t=PPx.Extract('%*extract("%*edittext()")'),r={add:{pre:"+",suf:"",rgx:"\\+"},del:{pre:"-",suf:"",rgx:"\\-"},addsub:{pre:"*",suf:",\\",rgx:"\\*"},remove:{pre:"",suf:"",rgx:"(\\*|\\+|\\-)"}}[e],n=new RegExp("^"+r.rgx+t.replace(/\\/g,"\\\\")+"(,\\\\)?$","i"),i=s({path:x(p.scanRule),enc:c}),a=(i[0],i[1]),l="string"==typeof a?[]:a.lines,f=l.length;f>=0;f--)n.test(l[f])&&l.splice(f,1);"remove"!==e&&l.push(""+r.pre+t+r.suf),u({path:p.scanRule,data:l,enc:c,overwrite:!0,linefeed:o})};!function(){!n.FileExists(p.scanRule)&&PPx.Execute("*makefile "+p.scanRule);var e=s({path:x(p.fpath),enc:c}),t=e[0],r=e[1];if(function(e,t){return e&&"string"==typeof t}(t,r))PPx.Echo("PPXFPATH.TXT "+f.notExists);else{r.lines.shift(),r.lines.pop();var i=PPx.Arguments.length>0?PPx.Arguments.Item(0):"update";if("update"!==i){var a=P(i);if(a)return void PPx.Echo(a)}PPx.Execute("%Os "+p.scanExe),u({path:x(p.upath),data:r.lines,enc:c,append:!0,linefeed:o}),PPx.Execute("*completelist -reload"),PPx.linemessage(f.update)}}();
