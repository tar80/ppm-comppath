var e,t="jp",r="\r\n",n=PPx.CreateObject("Scripting.FileSystemObject"),i=1024,a={TypeToCode:{crlf:"\r\n",cr:"\r",lf:"\n"},CodeToType:{"\r\n":"crlf","\r":"cr","\n":"lf"},Ppx:{lf:"%%bl",cr:"%%br",crlf:"%%bn",unix:"%%bl",mac:"%%br",dos:"%%bn","\n":"%%bl","\r":"%%br","\r\n":"%%bn"},Ascii:{lf:"10",cr:"13",crlf:"-1",unix:"10",mac:"13",dos:"-1","\n":"10","\r":"13","\r\n":"-1"}},l=function(e,t){return e&&"string"==typeof t},s=function(e,t){try{var r;return[!1,null!=(r=t())?r:""]}catch(n){return[!0,""]}finally{e.Close()}},u=function(e){var t=e.path,r=e.enc,i=function(e){var t=e.path,r=e.enc,i=void 0===r?"utf8":r;if(!n.FileExists(t))return[!0,t+" not found"];var a=n.GetFile(t);if(0===a.Size)return[!0,t+" has no data"];var l=!1,u="";if("utf8"===i){var o=PPx.CreateObject("ADODB.Stream"),c=s(o,(function(){return o.Open(),o.Charset="UTF-8",o.LoadFromFile(t),o.ReadText(-1)}));l=c[0],u=c[1]}else{var f="utf16le"===i?-1:0,p=a.OpenAsTextStream(1,f),P=s(p,(function(){return p.ReadAll()}));l=P[0],u=P[1]}return l?[!0,"Unable to read "+t]:[!1,u]}({path:t,enc:void 0===r?"utf8":r}),a=i[0],l=i[1];if(a)return[!0,l];var u=function(e){var t="\n",r=e.indexOf("\r");return~r&&(t="\r\n"==e.substring(r,r+2)?"\r\n":"\r"),t}(l.slice(0,1e3)),o=l.split(u);return""===o[o.length-1]&&o.pop(),[!1,{lines:o,nl:u}]},o=function(e){var t=e.path,i=e.data,l=e.enc,u=void 0===l?"utf8":l,o=e.append,c=void 0!==o&&o,f=e.overwrite,p=void 0!==f&&f,P=e.linefeed,x=void 0===P?r:P;if(!p&&!c&&n.FileExists(t))return[!0,t+" already exists"];var d,v=n.GetParentFolderName(t);if(n.FolderExists(v)||PPx.Execute("*makedir "+v),"utf8"===u){if("ClearScriptV8"===PPx.ScriptEngineName){var T=i.join(x),h=c?"AppendAllText":"WriteAllText";return[!1,NETAPI.System.IO.File[h](t,T)]}var E=p||c?2:1,m=PPx.CreateObject("ADODB.Stream");d=s(m,(function(){m.Open(),m.Charset="UTF-8",m.LineSeparator=Number(a.Ascii[x]),c?(m.LoadFromFile(t),m.Position=m.Size,m.SetEOS):m.Position=0,m.WriteText(i.join(x),1),m.SaveToFile(t,E)}))[0]}else{var b=c?8:p?2:1,A="utf16le"===u?-1:0,F=n.GetFile(t).OpenAsTextStream(b,A);d=s(F,(function(){F.Write(i.join(x)+x)}))[0]}return d?[!0,"Could not write to "+t]:[!1,""]},c="sjis",f=r,p={scanExe:(e=PPx.Extract("%0%\\"))+"fenrirScan.exe",scanRule:e+"ScanRule.ini",fpath:e+"PPXFPATH.TXT",upath:e+"PPXUPATH.TXT"},P={en:{notExists:"does not exist",update:"Update PPXUPATH.TXT"},jp:{notExists:"がありません",update:"PPXUPATH.TXT を更新しました"}}[function(){var e=PPx.Extract("%*getcust(S_ppm#global:lang)");return"en"===e||"jp"===e?e:t}()],x=function(e){var t=n.GetFile(e);return i&t.Attributes?PPx.Extract("%*linkedpath("+e+")"):e},d=function(e){var t=u({path:x(p.scanRule),enc:c}),r=t[0],n=t[1];if(l(r,n))return n;for(var i=PPx.Extract('%*extract("%*edittext()")').toLowerCase(),a=new RegExp("^(\\*|\\+|\\-)"+i.replace(/\\/g,"\\\\")+"(,\\\\)?"),s=n.lines,P=s.length;P>=0;P--)a.test(s[P])&&s.splice(P,1);if("remove"!==e){var d={add:{pre:"+",suf:""},del:{pre:"-",suf:""},addsub:{pre:"*",suf:",\\"}}[e];s.push(""+d.pre+i+d.suf)}o({path:p.scanRule,data:s,enc:c,overwrite:!0,linefeed:f})};!function(){if(n.FileExists(p.scanRule)){var e=u({path:x(p.fpath),enc:c}),t=e[0],r=e[1];if(l(t,r))PPx.Echo("PPXFPATH.TXT "+P.notExists);else{r.lines.pop();var i=PPx.Arguments.length>0?PPx.Arguments.Item(0):"update";if("update"!==i){var a=d(i);if(a)return void PPx.Echo(a)}PPx.Execute("%Os "+p.scanExe),o({path:p.upath,data:r.lines,enc:c,append:!0,linefeed:f}),PPx.Execute("*completelist -reload"),PPx.linemessage(P.update)}}else PPx.Echo("ScanRule.ini "+P.notExists)}();
