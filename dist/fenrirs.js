var e,t="jp",r="\r\n",n=PPx.CreateObject("Scripting.FileSystemObject"),i=1024,a={TypeToCode:{crlf:"\r\n",cr:"\r",lf:"\n"},CodeToType:{"\r\n":"crlf","\r":"cr","\n":"lf"},Ppx:{lf:"%%bl",cr:"%%br",crlf:"%%bn",unix:"%%bl",mac:"%%br",dos:"%%bn","\n":"%%bl","\r":"%%br","\r\n":"%%bn"},Ascii:{lf:"10",cr:"13",crlf:"-1",unix:"10",mac:"13",dos:"-1","\n":"10","\r":"13","\r\n":"-1"}},l=function(e,t){try{var r;return[!1,null!=(r=t())?r:""]}catch(n){return[!0,""]}finally{e.Close()}},s=function(e){var t=e.path,r=e.enc,i=function(e){var t=e.path,r=e.enc,i=void 0===r?"utf8":r;if(!n.FileExists(t))return[!0,t+" not found"];var a=n.GetFile(t);if(0===a.Size)return[!0,t+" has no data"];var s=!1,u="";if("utf8"===i){var o=PPx.CreateObject("ADODB.Stream"),c=l(o,(function(){return o.Open(),o.Charset="UTF-8",o.LoadFromFile(t),o.ReadText(-1)}));s=c[0],u=c[1]}else{var f="utf16le"===i?-1:0,p=a.OpenAsTextStream(1,f),x=l(p,(function(){return p.ReadAll()}));s=x[0],u=x[1]}return s?[!0,"Unable to read "+t]:[!1,u]}({path:t,enc:void 0===r?"utf8":r}),a=i[0],s=i[1];if(a)return[!0,s];var u=function(e){var t="\n",r=e.indexOf("\r");return~r&&(t="\r\n"==e.substring(r,r+2)?"\r\n":"\r"),t}(s.slice(0,1e3)),o=s.split(u);return""===o[o.length-1]&&o.pop(),[!1,{lines:o,nl:u}]},u=function(e){var t=e.path,i=e.data,s=e.enc,u=void 0===s?"utf8":s,o=e.append,c=void 0!==o&&o,f=e.overwrite,p=void 0!==f&&f,x=e.linefeed,P=void 0===x?r:x;if(!p&&!c&&n.FileExists(t))return[!0,t+" already exists"];var d,v=n.GetParentFolderName(t);if(n.FolderExists(v)||PPx.Execute("*makedir "+v),"utf8"===u){if("ClearScriptV8"===PPx.ScriptEngineName){var T=i.join(P),h=c?"AppendAllText":"WriteAllText";return[!1,NETAPI.System.IO.File[h](t,T)]}var m=p||c?2:1,E=PPx.CreateObject("ADODB.Stream");d=l(E,(function(){E.Open(),E.Charset="UTF-8",E.LineSeparator=Number(a.Ascii[P]),c?(E.LoadFromFile(t),E.Position=E.Size,E.SetEOS):E.Position=0,E.WriteText(i.join(P),1),E.SaveToFile(t,m)}))[0]}else{var g=c?8:p?2:1,b="utf16le"===u?-1:0,A=n.GetFile(t).OpenAsTextStream(g,b);d=l(A,(function(){A.Write(i.join(P)+P)}))[0]}return d?[!0,"Could not write to "+t]:[!1,""]},o="sjis",c=r,f={scanExe:(e=PPx.Extract("%0%\\"))+"fenrirScan.exe",scanRule:e+"ScanRule.ini",fpath:e+"PPXFPATH.TXT",upath:e+"PPXUPATH.TXT"},p={en:{notExists:"does not exist",update:"Update PPXUPATH.TXT"},jp:{notExists:"がありません",update:"PPXUPATH.TXT を更新しました"}}[function(){var e=PPx.Extract("%*getcust(S_ppm#global:lang)");return"en"===e||"jp"===e?e:t}()],x=function(e){var t=n.GetFile(e);return i&t.Attributes?PPx.Extract("%*linkedpath("+e+")"):e},P=function(e){for(var t=PPx.Extract('%*extract("%*edittext()")').toLowerCase(),r={add:{pre:"+",suf:"",rgx:"\\+"},del:{pre:"-",suf:"",rgx:"\\-"},addsub:{pre:"*",suf:",\\",rgx:"\\*"},remove:{pre:"",suf:"",rgx:"(\\*|\\+|\\-)"}}[e],n=new RegExp("^"+r.rgx+t.replace(/\\/g,"\\\\")+"(,\\\\)?$"),i=s({path:x(f.scanRule),enc:o}),a=(i[0],i[1]),l="string"==typeof a?[]:a.lines,p=l.length;p>=0;p--)n.test(l[p])&&l.splice(p,1);"remove"!==e&&l.push(""+r.pre+t+r.suf),u({path:f.scanRule,data:l,enc:o,overwrite:!0,linefeed:c})};!function(){!n.FileExists(f.scanRule)&&PPx.Execute("*makefile "+f.scanRule);var e=s({path:x(f.fpath),enc:o}),t=e[0],r=e[1];if(function(e,t){return e&&"string"==typeof t}(t,r))PPx.Echo("PPXFPATH.TXT "+p.notExists);else{r.lines.shift(),r.lines.pop();var i=PPx.Arguments.length>0?PPx.Arguments.Item(0):"update";if("update"!==i){var a=P(i);if(a)return void PPx.Echo(a)}PPx.Execute("%Os "+f.scanExe),u({path:x(f.upath),data:r.lines,enc:o,append:!0,linefeed:c}),PPx.Execute("*completelist -reload"),PPx.linemessage(p.update)}}();
